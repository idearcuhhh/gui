local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local transformationMap = {
    ["Divine Rose Prominence"] = "[DRP]",
    ["Astral Instinct"] = "[AI]",
    ["Ultra Instinct"] = "[UI]",
    ["Mastered Ultra Instinct"] = "[MUI]",
    ["Ultra Ego"] = "[UE]",
    ["God of Destruction"] = "[GOD]",
    ["God of Creation"] = "[GOC]",
    ["Divine Blue"] = "[DB]",
    ["Jiren Ultra Instinct"] = "[JUI]"
}

-- Function to get a player's transformation
local function getPlayerTransformation(player)
    local playerData = game.Players:FindFirstChild(player.Name)
    if not playerData then return "[Base]" end

    local statusFolder = playerData:FindFirstChild("Status")
    if not statusFolder then return "[Base]" end

    local transformation = statusFolder:FindFirstChild("Transformation")
    if transformation and transformation:IsA("StringValue") then
        return transformationMap[transformation.Value] or "[Base]"
    end

    return "[Base]"
end

-- Function to format large numbers (health display)
local function abbreviateNumber(num)
    local suffixes = {"", "K", "M", "B", "T", "QD"}
    local index = 1

    while num >= 1000 and index < #suffixes do
        num = num / 1000
        index = index + 1
    end

    return string.format("%.1f%s", num, suffixes[index])
end

-- Function to update the billboard UI
local function updateBillboard(billboard, player)
    local character = player.Character
    if not character then return end

    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end

    local health = humanoid.Health
    local maxHealth = humanoid.MaxHealth
    local formattedHealth = string.format("%s/%s HP", abbreviateNumber(health), abbreviateNumber(maxHealth))

    local form = getPlayerTransformation(player)
    local displayText = string.format("%s %s [@%s] | [%s]", form, player.DisplayName, player.Name, formattedHealth)

    billboard.TextLabel.Text = displayText
end

-- Function to set up the billboard UI
local function createBillboard(player)
    local character = player.Character
    if not character then return end

    local head = character:FindFirstChild("Head")
    if not head then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "PlayerBillboard"
    billboard.Size = UDim2.new(4, 0, 1, 0)
    billboard.StudsOffset = Vector3.new(0, 2, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head

    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextScaled = false
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.TextStrokeTransparency = 0.3
    textLabel.Parent = billboard

    -- Update the UI every frame
    RunService.RenderStepped:Connect(function()
        if billboard.Parent then
            updateBillboard(billboard, player)
        end
    end)
end

-- Apply billboard when player joins
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        task.wait(1) -- Small delay to let character load
        createBillboard(player)
    end)
end)

-- Apply billboard for existing players (in case script starts mid-game)
for _, player in pairs(Players:GetPlayers()) do
    if player.Character then
        createBillboard(player)
    end
end
